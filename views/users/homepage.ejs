<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/homepage.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Carattere&display=swap" rel="stylesheet">
</head>
<body>
<%- include('../partials/_navbar.ejs') %>

<% if (user && user.username) { %>
  <h1>Welcome <%= user.username %>!</h1>
<% } %>

<p1>Your personalized habit tracking dashboard is ready.</p1>

<h2>Today's Habits:</h2>
   <div id="habit-list">
  <% if (habits && habits.length) { %>
    <ul>
      <% habits.forEach(habit => {
        const lastComplete = (habit.habitLog || [])
          .filter(log => log.status === 'completed')
          .sort((a,b)=> new Date(b.date) - new Date(a.date))[0];

        let isComplete = false;
        if (lastComplete) {
          const lastDate = new Date(lastComplete.date);
          const today = new Date();
          isComplete = lastDate.toDateString() === today.toDateString();
        }
      %>   <li class="<%= isComplete ? 'complete' : 'incomplete' %>">
          <a href="/habits/<%= habit._id %>/edit">
            <strong><%= habit.title %></strong> - <%= habit.description %>
          </a>

          <% if (isComplete) { %>
            <span>(Completed today)</span>
          <% } else { %>
            <form action="/habits/<%= habit._id %>/complete" method="POST" style="display:inline;">
              <button type="submit">Mark Complete</button>
            </form>
          <% } %>
          <a href="/logs/<%= habit._id %>">View Logs</a>

          
          <% /* Progress Calculation: distinct completed days vs duration */
             const completedDaysSet = new Set((habit.habitLog||[])
               .filter(l => l.status === 'completed')
               .map(l => new Date(l.date).toDateString()));
             const completedDays = completedDaysSet.size;
             const totalDays = habit.duration || 1; // avoid divide by zero
             const pctRaw = (completedDays / totalDays) * 100;
             const pct = pctRaw > 100 ? 100 : Math.round(pctRaw);
          %>
          <div class="progress-wrapper" aria-label="Progress for <%= habit.title %>" role="group">
            <div class="progress-label">
              <span>Progress</span>
              <span><%= completedDays %>/<%= totalDays %> days</span>
            </div>
            <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= pct %>">
              <div class="progress-bar" <%= `style="width:${pct}%"` %>></div>
            </div>
            <div class="progress-pct"><%= pct %>%</div>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No habits found for today. Let's create some!</p>
  <% } %>
</div>
<p2>Keep up the great work!</p2>

</body>
</html>